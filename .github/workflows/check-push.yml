name: CI Check - Push

on:
  push:
  workflow_call:

permissions:
  contents: read

jobs:
  # TODO:
  # - test report should use discord-notify to report result
  # - test report should use step-summary.yml to create a summary
  # - add PSScriptAnalyzer
  # - add JSON Prettier check

  validate-syntax:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install actionlint
        shell: bash
        run: |
          bash <(curl -s https://raw.githubusercontent.com/rhysd/actionlint/main/scripts/download-actionlint.bash)

      - name: Run actionlint validation
        shell: bash
        id: actionlint
        run: |
          if ./actionlint > actionlint.log 2>&1; then
            echo "validation_result=success" >> "$GITHUB_OUTPUT"
          else
            echo "validation_result=failed" >> "$GITHUB_OUTPUT"
            cat actionlint.log
            exit 1
          fi

      - name: Write validation results
        shell: bash
        if: always()
        run: |
          if [[ "${{ steps.actionlint.outputs.validation_result }}" == "success" ]]; then
            cat >> "$GITHUB_STEP_SUMMARY" << 'EOF'
          ✅ **Workflow Syntax Validation Passed**
          
          All workflows passed syntax validation successfully.
          EOF
          else
            cat >> "$GITHUB_STEP_SUMMARY" << 'EOF'
          ❌ **Workflow Syntax Validation Failed**
          
          One or more workflows failed syntax validation. Check the details below:
          
          ```
          EOF
            # Append actionlint output (limit to first 50 lines for readability)
            head -50 actionlint.log >> "$GITHUB_STEP_SUMMARY" 2>/dev/null || echo "No actionlint output available" >> "$GITHUB_STEP_SUMMARY"
            cat >> "$GITHUB_STEP_SUMMARY" << 'EOF'
          ```
          EOF
          fi