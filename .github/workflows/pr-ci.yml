name: PR CI - Workflow Validation

on:
  pull_request:
    paths:
      - '.github/workflows/**'

permissions:
  contents: read

jobs:
  validate-syntax:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-tags: ${{ !env.ACT }}  # Only fetch tags when NOT under act

      - name: Install actionlint
        shell: bash
        run: |
          bash <(curl -s https://raw.githubusercontent.com/rhysd/actionlint/main/scripts/download-actionlint.bash)

      - name: Run actionlint validation
        shell: bash
        id: actionlint
        run: |
          if ./actionlint > actionlint.log 2>&1; then
            echo "validation_result=success" >> "$GITHUB_OUTPUT"
          else
            echo "validation_result=failed" >> "$GITHUB_OUTPUT"
            cat actionlint.log
            exit 1
          fi

      - name: Write validation results
        shell: bash
        if: always()
        run: |
          if [[ "${{ steps.actionlint.outputs.validation_result }}" == "success" ]]; then
            cat >> "$GITHUB_STEP_SUMMARY" << 'EOF'
          ✅ **Workflow Syntax Validation Passed**
          
          All workflows passed syntax validation successfully.
          EOF
          else
            cat >> "$GITHUB_STEP_SUMMARY" << 'EOF'
          ❌ **Workflow Syntax Validation Failed**
          
          One or more workflows failed syntax validation. Check the details below:
          
          ```
          EOF
            # Append actionlint output (limit to first 50 lines for readability)
            head -50 actionlint.log >> "$GITHUB_STEP_SUMMARY" 2>/dev/null || echo "No actionlint output available" >> "$GITHUB_STEP_SUMMARY"
            cat >> "$GITHUB_STEP_SUMMARY" << 'EOF'
          ```
          EOF
          fi

  build-discord-fields-validation:
    runs-on: ubuntu-latest
    needs: validate-syntax
    if: always()
    outputs:
      discord_fields: ${{ steps.discord_fields.outputs.fields }}
    
    steps:
      - name: Build Discord Fields
        id: discord_fields
        env:
          HEAD_REF: ${{ github.head_ref }}
        run: |
          # Build JSON fields with readable formatting
          FIELDS=$(jq -n \
            --arg repo "${{ github.repository }}" \
            --arg pr_number "${{ github.event.pull_request.number }}" \
            --arg branch "$HEAD_REF" \
            --arg run_url "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}" \
            '[
              {"name": "Repository", "value": $repo, "inline": true},
              {"name": "PR Number", "value": ("#" + $pr_number), "inline": true},
              {"name": "Branch", "value": $branch, "inline": true},
              {"name": "Run", "value": ("[View Details](" + $run_url + ")"), "inline": false}
            ]')
          
          # Use delimiter to safely output the multiline JSON
          delimiter="$(openssl rand -hex 8)"
          {
            echo "fields<<${delimiter}"
            echo "$FIELDS"
            echo "${delimiter}"
          } >> "$GITHUB_OUTPUT"

  notify-validation:
    uses: ./.github/workflows/discord-notify.yml
    needs: [validate-syntax, build-discord-fields-validation]
    if: always()
    secrets:
      webhook_url: ${{ secrets.DISCORD_WEBHOOK_URL }}
    with:
      message_type: "embed"
      title: ${{ needs['validate-syntax'].result == 'success' && '✅ Workflow Validation Passed' || '❌ Workflow Validation Failed' }}
      description: ${{ needs['validate-syntax'].result == 'success' && 'All workflows in the pull request passed syntax validation successfully.' || 'One or more workflows failed syntax validation. Please check the workflow run for details.' }}
      color: ${{ needs['validate-syntax'].result == 'success' && '3066993' || '15158332' }}
      fields: ${{ needs.build-discord-fields-validation.outputs.discord_fields }}

  test-step-summary:
    uses: ./.github/workflows/step-summary.yml
    needs: validate-syntax
    if: always()
    with:
      title: "Mock Test Results"
      markdown: |
        ### Test Results
        
        - ✅ Test 1 passed
        - ✅ Test 2 passed
        - ✅ All validations completed
        
        ```bash
        Mock output from test execution
        ```
        
        **Summary**: All tests completed successfully.
      overwrite: false

  verify-execution:
    runs-on: ubuntu-latest
    needs: [validate-syntax, test-step-summary]
    if: always()
    steps:
      - name: Verify execution
        shell: bash
        run: |
          echo "Reusable workflow test completed successfully"
          cat >> "$GITHUB_STEP_SUMMARY" << 'EOF'
          
          ---
          
          ✅ **Reusable Workflow Test Passed**
          
          The step-summary.yml workflow was called successfully with mock data.
          EOF

  build-discord-fields-completion:
    runs-on: ubuntu-latest
    needs: [validate-syntax, test-step-summary, verify-execution]
    if: always()
    outputs:
      discord_fields: ${{ steps.discord_fields.outputs.fields }}
    
    steps:
      - name: Build Discord Fields
        id: discord_fields
        run: |
          VALIDATION_STATUS="${{ needs['validate-syntax'].result }}"
          SUMMARY_STATUS="${{ needs['test-step-summary'].result }}"
          EXECUTION_STATUS="${{ needs['verify-execution'].result }}"
          
          # Build JSON fields with readable formatting
          FIELDS=$(jq -n \
            --arg validation_status "$VALIDATION_STATUS" \
            --arg summary_status "$SUMMARY_STATUS" \
            --arg execution_status "$EXECUTION_STATUS" \
            --arg pr_number "${{ github.event.pull_request.number }}" \
            --arg pr_url "${{ github.event.pull_request.html_url }}" \
            --arg actor "${{ github.actor }}" \
            --arg run_url "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}" \
            '[
              {"name": "Syntax Validation", "value": (($validation_status == "success" and "✅ Passed" or "❌ Failed")), "inline": true},
              {"name": "Step Summary Test", "value": (($summary_status == "success" and "✅ Passed" or "❌ Failed")), "inline": true},
              {"name": "Execution Verification", "value": (($execution_status == "success" and "✅ Passed" or "❌ Failed")), "inline": true},
              {"name": "PR Details", "value": ("[#" + $pr_number + "](" + $pr_url + ") by @" + $actor), "inline": false},
              {"name": "Run Details", "value": ("[View Full Run](" + $run_url + ")"), "inline": false}
            ]')
          
          # Use delimiter to safely output the multiline JSON
          delimiter="$(openssl rand -hex 8)"
          {
            echo "fields<<${delimiter}"
            echo "$FIELDS"
            echo "${delimiter}"
          } >> "$GITHUB_OUTPUT"

  notify-completion:
    uses: ./.github/workflows/discord-notify.yml
    needs: [validate-syntax, test-step-summary, verify-execution, build-discord-fields-completion]
    if: always()
    secrets:
      webhook_url: ${{ secrets.DISCORD_WEBHOOK_URL }}
    with:
      message_type: "embed"
      title: ${{ needs['validate-syntax'].result == 'success' && needs['test-step-summary'].result == 'success' && needs['verify-execution'].result == 'success' && '✅ PR CI Workflow Completed Successfully' || '⚠️ PR CI Workflow Completed with Issues' }}
      description: ${{ needs['validate-syntax'].result == 'success' && needs['test-step-summary'].result == 'success' && needs['verify-execution'].result == 'success' && 'All validation checks and tests passed successfully. The pull request is ready for review.' || 'The workflow completed but some checks failed. Please review the results and address any issues.' }}
      color: ${{ needs['validate-syntax'].result == 'success' && needs['test-step-summary'].result == 'success' && needs['verify-execution'].result == 'success' && '3066993' || '16776960' }}
      fields: ${{ needs.build-discord-fields-completion.outputs.discord_fields }}