name: "Install Red-DiscordBot"
description: "Downloads a Red-DiscordBot build artifact and installs it using uv."

inputs:
  artifact_name:
    description: "Optional artifact name to download. Default: red-discordbot-build"
    required: false

runs:
  using: "composite"
  steps:
    - name: Download Red-DiscordBot artifact
      if: ${{ inputs.artifact_name != '' && env.ACT != 'true' }}  # Skip download when running with act or no artifact name provided
      uses: actions/download-artifact@v4
      with:
        name: ${{ inputs.artifact_name }}
        path: ./dist

    - name: Copy local artifact for act
      if: env.ACT == 'true'  # On act use local mounted artifact
      shell: bash
      run: |
        # Use the mounted path inside container path\to\Red-DiscordBot\dist:/tmp/dist
        mkdir -p ./dist
        if compgen -G "/tmp/dist/*" > /dev/null; then
          cp /tmp/dist/* ./dist/
        else
          echo "âŒ No files found in /tmp/dist. Installing from PyPI."
        fi

    # todo: python version should be configurable, skip if python is already setup
    - name: Set up Python 3.11
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Install uv
      uses: astral-sh/setup-uv@v1

    # Red-DiscordBot is installed locally if ./dist contains built wheels else install from PyPI
    - name: Install Red-DiscordBot
      shell: bash
      run: |
        if [[ -d "./dist" && $(ls -A ./dist/*.whl 2>/dev/null) ]]; then
          echo "ðŸ“¦ Installing Red-DiscordBot from local artifact in ./dist"
          uv pip install ./dist/*.whl --system
        else
          echo "ðŸ“¦ Installing Red-DiscordBot from PyPI"
          uv pip install Red-DiscordBot --system
        fi

    - name: Verify installation
      shell: bash
      run: |
        python -c "import redbot; print('âœ… Red-DiscordBot installed successfully')"
