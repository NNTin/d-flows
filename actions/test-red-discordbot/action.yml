name: "Test Red-DiscordBot cogs"
description: "Loads and unloads cogs via RPC to verify they work inside Red-DiscordBot."

inputs:
  token:
    description: "Discord bot token used when starting Red-DiscordBot"
    required: true
  cog_paths:
    description: "Comma-separated list of cog directories to validate"
    required: true
  rpc_port:
    description: "Port Red-DiscordBot RPC server listens on"
    required: false
    default: "6133"

runs:
  using: "composite"
  steps:
    - name: Install RPC client dependencies
      shell: bash
      run: |
        set -euo pipefail
        echo "üì¶ Installing aiohttp for RPC client"
        python3 -m pip install --upgrade pip
        python3 -m pip install --upgrade aiohttp

    - name: Start Red-DiscordBot and run RPC cog tests
      shell: bash
      env:
        COG_PATHS: ${{ inputs.cog_paths }}
        RPC_PORT: ${{ inputs.rpc_port }}
      run: |
        set -euo pipefail
        trap 'if [[ -n "${BOT_PID:-}" ]]; then echo "üõë Stopping Red-DiscordBot (${BOT_PID})"; kill "${BOT_PID}" 2>/dev/null || true; wait "${BOT_PID}" 2>/dev/null || true; fi' EXIT

        LOG_PATH="${{ runner.temp }}/redbot-rpc.log"
        echo "üìÅ Writing Red-DiscordBot logs to ${LOG_PATH}"

        INSTALL_PATH="$(python3 -c $'import asyncio\nfrom redbot.core import data_manager\nfrom redbot.core._cog_manager import CogManager\n\ndata_manager.load_basic_configuration(\"tinkerer\")\n\nasync def main():\n    mgr = CogManager()\n    path = await mgr.install_path()\n    print(path)\n\nasyncio.run(main())')"
        if [[ -z "${INSTALL_PATH}" ]]; then
          echo "‚ùå Failed to determine cog install path"
          exit 1
        fi
        echo "üìÅ Installing cogs to ${INSTALL_PATH}"
        mkdir -p "${INSTALL_PATH}"
        IFS=',' read -ra RAW_COG_PATHS <<< "${COG_PATHS}"
        for raw in "${RAW_COG_PATHS[@]}"; do
          trimmed="$(echo "${raw}" | xargs || true)"
          if [[ -z "${trimmed}" ]]; then
            continue
          fi
          if [[ ! -d "${trimmed}" ]]; then
            echo "‚ùå Cog path ${trimmed} does not exist"
            exit 1
          fi
          src="$(realpath "${trimmed}")"
          cog_name="$(basename "${src}")"
          dest="${INSTALL_PATH}/${cog_name}"
          if [[ "${src}" == "${dest}" ]]; then
            echo "‚ÑπÔ∏è Cog ${cog_name} already installed at ${dest}; skipping copy"
            continue
          fi
          echo "üìÇ Installing ${src} -> ${dest}"
          rm -rf "${dest}"
          cp -a "${src}" "${dest}"
        done

        echo "üöÄ Launching Red-DiscordBot in the background"
        python3 -m redbot tinkerer \
          --token "${{ inputs.token }}" \
          --prefix "!" \
          --rpc \
          --rpc-port "${{ inputs.rpc_port }}" \
          > "${LOG_PATH}" 2>&1 &
        BOT_PID=$!

        sleep 5
        if ! ps -p "${BOT_PID}" > /dev/null; then
          echo "‚ùå Red-DiscordBot did not stay running. Last log lines:"
          tail -n 100 "${LOG_PATH}" || true
          exit 1
        fi
        echo "‚úÖ Red-DiscordBot is running with PID ${BOT_PID}"

        SCRIPT_PATH="${{ github.action_path }}/test_rpc_cogs.py"
        if [[ ! -f "${SCRIPT_PATH}" ]]; then
          echo "‚ùå Missing helper script at ${SCRIPT_PATH}"
          exit 1
        fi

        set +e
        python3 "${SCRIPT_PATH}"
        status=$?
        set -e

        if [[ $status -ne 0 ]]; then
          echo "ü™µ Dumping Red-DiscordBot log tail after failure"
          tail -n 200 "${LOG_PATH}" || true
        else
          echo "üéâ RPC cog tests passed"
        fi

        exit $status
