{
  "name": "Invalid Branch Format Error Recovery",
  "description": "Focus: accidental release branch with invalid name is handled gracefully",
  "steps": [
    {
      "name": "Making sure we are on main branch",
      "action": "execute-command",
      "command": "git checkout main"
    },
    {
      "name": "Setup complete release history",
      "action": "setup-git-state",
      "scenario": "FirstRelease",
      "expectedState": {
        "tags": [],
        "branches": ["main"],
        "currentBranch": "main"
      }
    },
    {
      "name": "Creating empty commit before release",
      "action": "execute-command",
      "command": "git commit --allow-empty -m 'Trigger release v0.1.0'"
    },
    {
      "name": "Execute v0.1.0 release workflow",
      "action": "run-workflow",
      "workflow": "release.yml",
      "fixture": "tests/release/valid-release-v0.1.0.json",
      "expectedOutputs": {
        "MAJOR_VERSION": "0"
      }
    },
    {
      "name": "Creating empty commit so not on same commit hash",
      "action": "execute-command",
      "command": "git commit --allow-empty -m 'different hash after release v0.1.0'"
    },
    {
      "name": "Create feature branch with invalid format",
      "action": "execute-command",
      "command": "git checkout -b test/integration/rollback-invalid-branch"
    },
    {
      "name": "Validate new branch exists",
      "action": "validate-state",
      "checks": [
        {"type": "current-branch", "branch": "test/integration/rollback-invalid-branch"}
      ]
    },
    {
      "name": "Creating empty commit before release",
      "action": "execute-command",
      "command": "git commit --allow-empty -m 'New commit on test/integration/rollback-invalid-branch'"
    },
    {
      "name": "Attempt bump on invalid branch (should fail)",
      "action": "run-workflow",
      "workflow": "bump-version.yml",
      "fixture": "tests/bump-version/error-invalid-branch-format.json",
      "expectedFailure": true,
      "expectedErrorMessage": ["branch", "format", "main", "release/v"]
    },
    {
      "name": "Validate release artifacts",
      "action": "validate-state",
      "checks": [
        {"type": "workflow-failure", "workflow": "release.yml"}
      ]
    },
    {
      "name": "Comment on failed attempt",
      "action": "comment",
      "text": "Note: This test is slightly different than rollback-unknown-branch since the branch test/integration/rollback-invalid-branch can be found on the remote, therefore we are proceeding."
    },
    {
      "name": "Validate no side effects from failed attempt",
      "action": "validate-state",
      "checks": [
        {"type": "tag-exists", "tag": "v0.1.0"},
        {"type": "tag-not-exists", "tag": "v0.1.1"},
        {"type": "branch-exists", "branch": "test/integration/rollback-invalid-branch"}
      ]
    },
    {
      "name": "Recover: Switch to main branch",
      "action": "execute-command",
      "command": "git checkout main"
    },
    {
      "name": "Validate recovery state",
      "action": "validate-state",
      "checks": [
        {"type": "current-branch", "branch": "main"}
      ]
    },
    {
      "name": "Retry bump on main branch",
      "action": "run-workflow",
      "workflow": "bump-version.yml",
      "fixture": "tests/bump-version/patch-bump-main.json",
      "expectedOutputs": {
        "NEW_VERSION": "0.1.1"
      }
    },
    {
      "name": "Execute v0.1.1 release workflow",
      "action": "run-workflow",
      "workflow": "release.yml",
      "fixture": "tests/release/valid-release-v0.1.1.json",
      "expectedOutputs": {
        "MAJOR_VERSION": "0"
      }
    },
    {
      "name": "Validate success after recovery",
      "action": "validate-state",
      "checks": [
        {"type": "tag-exists", "tag": "v0.1.1"},
        {"type": "current-branch", "branch": "main"}
      ]
    }
  ],
  "cleanup": {
    "action": "reset-git-state"
  },
  "expectedDuration": "30-60 seconds",
  "tags": ["integration", "error-recovery", "branch-validation", "resilience"]
}
